```{r initialization, echo = FALSE}
knitr::opts_chunk$set(cache = TRUE, cache.path = "./cache/cache_knitr/isoscape/", fig.path = "./cache/fig_knitr/isoscape/", global.par = TRUE, fig.align = "center", error = TRUE)
library(IsoriX)
```

# Building Isoscapes {#isoscape}

## Preparing the raw data

To get an isoscape, you need data of the isotope composition in space. In this documentation, we will use data provided by the Global Networks of Isotopes in Precipitation (GNIP) but you can use whatever source of data you prefer, or have access to. In any case, just make sure that you format your data the same way we do it so that IsoriX interpret your dataset as it should. Precisely, your dataset should be a ```data.frame``` with the same columns as the ones shown below in section \@ref(GNIPDataDE).

### The GNIP database {#GNIP}

You can download precipitation isotope data for hydrogen and oxygen from the Global Networks of Isotopes in Precipitation (GNIP).

To get to know what the GNIP is, its history, and more importantly its terms of use and information about the data, go there: http://www-naweb.iaea.org/napc/ih/IHS_resources_gnip.html

The GNIP data are free to download after the registration process is completed. The following link will bring you to the right place to create an account:
https://websso.iaea.org/IM/UserRegistrationPage.aspx?returnpage=http://nucleus.iaea.org/wiser

Once your acount has been activated, download the data you need from here:
https://nucleus.iaea.org/wiser/gnip.php

For the time being, downloads are limited to 10,000 records per batch, which makes the compilation of huge databases fastidious. GNIP promised to come up, in the future, with datasets directly prepared for IsoriX to save you the trouble. We are eagerly waiting for this to happen.

### A toy example: GNIPDataDE {#GNIPDataDE}

Within IsoriX we have already included a small extract from GNIP for you to try out the functions of the package without having to worry about the data. This small dataset corresponds to $\delta^2H$ values for Germany. The dataset has kindly been provided by GNIP with the authorization from Christine Stumpp. Here is what the beginning of the dataset looks like:

```{r GNIPDataDE, eval = FALSE}
head(GNIPDataDE)
```

```{r GNIPDataDE_bis, echo = FALSE}
knitr::kable(head(GNIPDataDE))
```

### A real example: GNIPDataEU {#GNIPDataEU}

Here we are going to show you how to prepare a dataset for IsoriX from a raw extract from GNIP. For this, we will use a file in which we have compiled the GNIP data for $\delta^2H$ values for the whole world. We are unfortunately not being able to share these data with you but you can download these data yourself as explained in section \@ref(GNIP).

We first import the data into R:

```{r GNIP_raw}
rawGNIP <- read.csv("./data/2016-10-31 Extract_ISORIX.csv")
```

This dataset contains ```r nrow(rawGNIP)``` rows and ```r ncol(rawGNIP)``` columns. For example the first row contains the following information:

```{r GNIP_raw_1st_row, echo = FALSE}
knitr::kable(t(rawGNIP[1, ])) ## we display the first row for this dataset as a column for visualisation
```

We are now going to reshape these data step-by-step to make them ready for IsoriX. We first reformat some temporal information:

```{r GNIP_date_extraction}
rawGNIP$year.begin  <- as.numeric(format(as.Date(rawGNIP$Begin.Of.Period), "%Y"))
rawGNIP$year.end    <- as.numeric(format(as.Date(rawGNIP$End.of.Period), "%Y"))
rawGNIP$year.span   <- rawGNIP$year.begin - rawGNIP$year.end
rawGNIP$month.begin <- as.numeric(format(as.Date(rawGNIP$Begin.Of.Period), "%m"))
rawGNIP$month.end   <- as.numeric(format(as.Date(rawGNIP$End.of.Period), "%m"))
rawGNIP$day.span    <- as.Date(rawGNIP$Begin.Of.Period) - as.Date(rawGNIP$End.of.Period)
rawGNIP$Year        <- as.numeric(format(as.Date(rawGNIP$Date), "%Y"))
rawGNIP$Month       <- as.numeric(format(as.Date(rawGNIP$Date), "%m"))
```

Second, we identify the rows for which crucial information is missing. Because we are going to make an isoscape based on deuterium measurements, we only check for the availability of data for this isotope in particular. If you work on oxygen, you will have to adjust the script accordingly. We also check that the intervals during which precipitation water has been collected for each measurement correspond roughly to one month:

```{r GNIP_bad_rows}
rows_missing_info <- is.na(rawGNIP$H2) |
                     is.na(rawGNIP$day.span) |
                     rawGNIP$day.span > -25 |
                     rawGNIP$day.span < -35 
```

Third, we only keep the rows and columns we are interested in:

```{r GNIP_select}
columns_to_keep <- c("Name.of.Site", "Latitude", "Longitude", "Altitude",
                     "Year", "Month", "H2")
GNIPData <- rawGNIP[!rows_missing_info, columns_to_keep]
```

Fourth, we turn the variable `Name.of.Site` into a factor:

```{r GNIP_factor}
GNIPData$Name.of.Site <- as.factor(GNIPData$Name.of.Site)
```

Last, we rename the columns to conform to the general IsoriX format and we check that the data seem correct:

```{r GNIP_change_column_names}
colnames(GNIPData) <- c("stationID", "lat", "long", "elev", "year", "month", "isoscape.value")
str(GNIPData)
```

This is what the beginning of `GNIPData` looks like:

```{r GNIP_show, eval = FALSE}
head(GNIPData)
```

```{r GNIP_show_bis, echo = FALSE}
knitr::kable(head(GNIPData))
```

As you can see, the format is the same as the one for `GNIPDataDE`, which is what we want.


## Processing the raw data

In order to build your isoscape with IsoriX, your dataset must be aggregated in such a way that each observation corresponds to the mean and variance of isotope values collected in one location, and potentially over fixed periods of time.

The time interval considered corresponds to the interval for which single isoscapes will be build. For example, if the interval is the month you will end up with one set of isoscapes for each month of the year (even if those can later be aggregated to form yearly isoscape as we shall see in section XX). 

To aggregate the data, you can choose to aggregate your dataset on your own, or to use our function `prepdata()`. This function allows you to aggregate the data over different time intervals. It also allows you to apply some restriction on the data, such as selecting only particular months, years, or locations.

Here we will use the function `prepdata()` to select from the dataset `GNIPData` the observations available within an extent of latitude and longitude that covers roughly Europe.

### Aggregation for a single set of isoscapes

We will start by using the default aggregation scheme, which simply produces an overall average per location.

```{r GNIP_EU_build}
GNIPDataEU <- prepdata(data = GNIPData,
                       long.min = -30, long.max = 60,
                       lat.min = 30, lat.max = 70)
```


Let us now visualise the beginning of the dataset:

```{r GNIPDataEU_view, eval = FALSE}
head(GNIPDataEU)
```

```{r GNIPDataEU_view_bis, echo = FALSE}
knitr::kable(head(GNIPDataEU))
```

### Aggregation for 12 set of isoscapes



