---
title: "How to produce precipitation-weighted annual average isoscapes in IsoriX?"
author: "The IsoriX core team"
date: "`r Sys.Date()`"
output:
    pdf_document
vignette: >
  %\VignetteIndexEntry{Precipitation-weighted annual average isoscapes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, initialization, echo=FALSE}
library(knitr)
set.seed(123)  ## set seed for entire manuscript
# set global options for knitr (if changed, all cashed chunked will be rerun!)
knitr::opts_chunk$set(cache = TRUE, cache.path = "./cache_knitr/", fig.path = "./fig_knitr/", global.par = TRUE, width = "\\linewidth", fig.align = "center", dev = "CairoPNG", dpi = 500) # use dpi=100 for small pdfs
docache <- TRUE
```

Welcome to __IsoriX__, in this vignette we present the steps required for you to build an annual average isoscape weighted by the amounth of monthly precipitation.

## Before starting

Please read the vignette ___Workflow___, if you haven't done so. You can access it by simply typing:

```{r, workflow, eval=FALSE}
vignette("Workflow", package="IsoriX")
```

Note that this vignette, like the one introducing the workflow takes a lot of time to run. It has thus not been compiled by CRAN but by us. We have included the sources of this vignette as a text file which you can find in your computer. This file is in the folder `IsoriX/doc` within the folder where you usually install your packages (the latter being usually the one that shows up when you type `.libPaths()[1]` in R).

Again, due to constraints on how big this document could be, we had to reduce a lot the resolution of the figures. If you run it on your computer you will see that in fact figures produced by __IsoriX__ are great!

Before starting, don't forget to load our package:
```{r, load package}
library(IsoriX)
```

## Step 1 - Select the isoscape data

Start by selecting the GNIP data needed for us to build an isoscape. In this example, we will consider all the data available in `GNIPdata` within an extent of latitude and longitude that covers roughly Europe. The difference with what we did in the vignette ___Workflow___ is that here the function `queryGNIP` is called with the argument `split.by = "month"`, we lead to data aggregated across years (as before), but not across months.

```{r, GNIP}
## load all the GNIP data
data(GNIPdata)

## select the relevant data
GNIPdataEU12 <- queryGNIP(
    data = GNIPdata,
    split.by = "month",
    long.min = -30, 
    long.max = 60,
    lat.min = 30, 
    lat.max = 70)
```

The dataset we created contains many more rows than the one used during the ___Workflow___ as we now have up to twelve different rows per location (i.e. one per month if records are available for all twelve months) instead of the single one.

```{r, GNIP2, echo=FALSE}
dim(GNIPdataEU12)
kable(head(GNIPdataEU12, 15L))
```

## Step 2 - Fit the geostatistical models

We will now fit not one pair of models as during the ___Workflow___ but twelve pairs of models. We indeed want to fit one mean model and one residual dispersion model for each of the twelve months of a year. Each of the twelve pairs of models are technically fitted independently, but to save you the manual labor of calling twelve times the function `isofit`, we have created the function `isomultifit` that does that for you. This latter function also combines all fitted models in one object of class `multiisofit` which other functions will recognize. As `isofit`, `isomultifit` can fit several model structures, but we will restrict the demonstration to a single example.

```{r, isofit, eval = FALSE}
Europefit12 <- isomultifit(iso.data = GNIPdataEU12,
                           split.by = "month",
                           mean.model.fix  = list(elev = TRUE, lat.abs = TRUE),
                           mean.model.rand = list("uncorr" = TRUE),
                           disp.model.rand = list("uncorr" = TRUE)
                           )
#save(Europefit12, file = "Europefit12.rda", compress = "xz")
```





